/**
* @license BSD-3-Clause
* @copyright 2014-2023 hizzgdev@163.com
*
* Project Home:
*   https://github.com/hizzgdev/jsmind/
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("jsmind")):"function"==typeof define&&define.amd?define(["jsmind"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).jsMind)}(this,(function(t){"use strict";function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=e(t);if(!i.default)throw new Error("jsMind is not defined");const s=i.default.$,o="getSelection"in s.w?function(){s.w.getSelection().removeAllRanges()}:function(){s.d.selection.empty()},n={line_width:5,line_color:"rgba(0,0,0,0.3)",drag_start_delay:100,lookup_delay:500,lookup_interval:80,scrolling_trigger_width:20,scrolling_step_length:10};class l{constructor(t,e){var s={};i.default.util.json.merge(s,n),i.default.util.json.merge(s,e),this.version="0.3.0",this.jm=t,this.options=s,this.e_canvas=null,this.canvas_ctx=null,this.shadow=null,this.shadow_w=0,this.shadow_h=0,this.active_node=null,this.target_node=null,this.target_direct=null,this.client_w=0,this.client_h=0,this.offset_x=0,this.offset_y=0,this.hlookup_delay=0,this.hlookup_timer=0,this.hdrag_start_delay=0,this.capture=!1,this.moved=!1,this.canvas_draggable=t.get_view_draggable(),this.view_panel=t.view.e_panel,this.view_panel_rect=null}init(){this._create_canvas(),this._create_shadow(),this._event_bind()}resize(){this.jm.view.e_nodes.appendChild(this.shadow),this.e_canvas.width=this.jm.view.size.w,this.e_canvas.height=this.jm.view.size.h}_create_canvas(){var t=s.c("canvas");this.jm.view.e_panel.appendChild(t);var e=t.getContext("2d");this.e_canvas=t,this.canvas_ctx=e}_create_shadow(){var t=s.c("jmnode");t.style.visibility="hidden",t.style.zIndex="3",t.style.cursor="move",t.style.opacity="0.7",this.shadow=t}reset_shadow(t){var e=this.shadow.style;this.shadow.innerHTML=t.innerHTML,e.left=t.style.left,e.top=t.style.top,e.width=t.style.width,e.height=t.style.height,e.backgroundImage=t.style.backgroundImage,e.backgroundSize=t.style.backgroundSize,e.transform=t.style.transform,this.shadow_w=this.shadow.clientWidth,this.shadow_h=this.shadow.clientHeight}show_shadow(){this.moved||(this.shadow.style.visibility="visible")}hide_shadow(){this.shadow.style.visibility="hidden"}_magnet_shadow(t){t&&(this.canvas_ctx.lineWidth=this.options.line_width,this.canvas_ctx.strokeStyle=this.options.line_color,this.canvas_ctx.lineCap="round",this._clear_lines(),this._canvas_lineto(t.sp.x,t.sp.y,t.np.x,t.np.y))}_clear_lines(){this.canvas_ctx.clearRect(0,0,this.jm.view.size.w,this.jm.view.size.h)}_canvas_lineto(t,e,i,s){this.canvas_ctx.beginPath(),this.canvas_ctx.moveTo(t,e),this.canvas_ctx.lineTo(i,s),this.canvas_ctx.stroke()}_lookup_close_node(){var t,e,s=this.jm.get_root(),o=s.get_location(),n=s.get_size(),l=o.x+n.w/2,h=this.shadow_w,a=this.shadow_h,_=this.shadow.offsetLeft,r=this.shadow.offsetTop,d=_+h/2>=l?i.default.direction.right:i.default.direction.left,c=this.jm.mind.nodes,g=null,u=this.jm.layout,v=Number.MAX_VALUE,p=0,w=null,f=null,m=null;for(var y in c){var b,j;if((g=c[y]).isroot||g.direction==d){if(g.id==this.active_node.id)continue;if(!u.is_visible(g))continue;if(t=g.get_size(),e=g.get_location(),d==i.default.direction.right){if(_-e.x-t.w<=0)continue;p=Math.abs(_-e.x-t.w)+Math.abs(r+a/2-e.y-t.h/2),b={x:e.x+t.w-this.options.line_width,y:e.y+t.h/2},j={x:_+this.options.line_width,y:r+a/2}}else{if(e.x-_-h<=0)continue;p=Math.abs(_+h-e.x)+Math.abs(r+a/2-e.y-t.h/2),b={x:e.x+this.options.line_width,y:e.y+t.h/2},j={x:_+h-this.options.line_width,y:r+a/2}}p<v&&(w=g,f=b,m=j,v=p)}}var x=null;return w&&(x={node:w,direction:d,sp:m,np:f}),x}lookup_close_node(){var t=this._lookup_close_node();t&&(this._magnet_shadow(t),this.target_node=t.node,this.target_direct=t.direction)}_event_bind(){var t=this,e=this.jm.view.container;s.on(e,"mousedown",(function(e){var i=e||event;t.hdrag_start_delay=s.w.setTimeout((function(){t.hdrag_start_delay=0,t.dragstart.call(t,i)}),t.options.drag_start_delay)})),s.on(e,"mousemove",(function(e){var i=e||event;t.drag.call(t,i)})),s.on(e,"mouseup",(function(e){var i=e||event;0!=t.hdrag_start_delay&&(s.w.clearTimeout(t.hdrag_start_delay),t.hdrag_start_delay=0),t.dragend.call(t,i)})),s.on(e,"touchstart",(function(e){var i=e||event;t.hdrag_start_delay=s.w.setTimeout((function(){t.hdrag_start_delay=0,t.dragstart.call(t,i)}),t.options.drag_start_delay)})),s.on(e,"touchmove",(function(e){var i=e||event;t.drag.call(t,i)})),s.on(e,"touchend",(function(e){var i=e||event;0!=t.hdrag_start_delay&&(s.w.clearTimeout(t.hdrag_start_delay),t.hdrag_start_delay=0),t.dragend.call(t,i)}))}dragstart(t){if(this.jm.get_editable()&&!this.capture){this.active_node=null,this.view_draggable=this.jm.get_view_draggable();var e=this.jm.view,i=t.target||event.srcElement;if("jmnode"==i.tagName.toLowerCase()){this.view_draggable&&this.jm.disable_view_draggable();var o=e.get_binded_nodeid(i);if(o){var n=this.jm.get_node(o);if(!n.isroot){this.reset_shadow(i),this.view_panel_rect=this.view_panel.getBoundingClientRect(),this.active_node=n,this.offset_x=(t.clientX||t.touches[0].clientX)/e.zoom_current-i.offsetLeft,this.offset_y=(t.clientY||t.touches[0].clientY)/e.zoom_current-i.offsetTop,this.client_hw=Math.floor(i.clientWidth/2),this.client_hh=Math.floor(i.clientHeight/2),0!=this.hlookup_delay&&s.w.clearTimeout(this.hlookup_delay),0!=this.hlookup_timer&&s.w.clearInterval(this.hlookup_timer);var l=this;this.hlookup_delay=s.w.setTimeout((function(){l.hlookup_delay=0,l.hlookup_timer=s.w.setInterval((function(){l.lookup_close_node.call(l)}),l.options.lookup_interval)}),this.options.lookup_delay),l.capture=!0}}}}}drag(t){if(this.jm.get_editable()&&this.capture){t.preventDefault(),this.show_shadow(),this.moved=!0,o();var e=this.jm.view,i=(t.clientX||t.touches[0].clientX)/e.zoom_current-this.offset_x,s=(t.clientY||t.touches[0].clientY)/e.zoom_current-this.offset_y;t.clientY-this.view_panel_rect.top<this.options.scrolling_trigger_width&&this.view_panel.scrollTop>this.options.scrolling_step_length?(this.view_panel.scrollBy(0,-this.options.scrolling_step_length),this.offset_y+=this.options.scrolling_step_length/e.zoom_current):this.view_panel_rect.bottom-t.clientY<this.options.scrolling_trigger_width&&this.view_panel.scrollTop<this.view_panel.scrollHeight-this.view_panel_rect.height-this.options.scrolling_step_length&&(this.view_panel.scrollBy(0,this.options.scrolling_step_length),this.offset_y-=this.options.scrolling_step_length/e.zoom_current),t.clientX-this.view_panel_rect.left<this.options.scrolling_trigger_width&&this.view_panel.scrollLeft>this.options.scrolling_step_length?(this.view_panel.scrollBy(-this.options.scrolling_step_length,0),this.offset_x+=this.options.scrolling_step_length/e.zoom_current):this.view_panel_rect.right-t.clientX<this.options.scrolling_trigger_width&&this.view_panel.scrollLeft<this.view_panel.scrollWidth-this.view_panel_rect.width-this.options.scrolling_step_length&&(this.view_panel.scrollBy(this.options.scrolling_step_length,0),this.offset_x-=this.options.scrolling_step_length/e.zoom_current),this.shadow.style.left=i+"px",this.shadow.style.top=s+"px",o()}}dragend(t){if(this.jm.get_editable()){if(this.view_draggable&&this.jm.enable_view_draggable(),this.capture){if(0!=this.hlookup_delay&&(s.w.clearTimeout(this.hlookup_delay),this.hlookup_delay=0,this._clear_lines()),0!=this.hlookup_timer&&(s.w.clearInterval(this.hlookup_timer),this.hlookup_timer=0,this._clear_lines()),this.moved){var e=this.active_node,i=this.target_node,o=this.target_direct;this.move_node(e,i,o)}this.hide_shadow()}this.view_panel_rect=null,this.moved=!1,this.capture=!1}}move_node(t,e,s){var o=this.shadow.offsetTop;if(e&&t&&!i.default.node.inherited(t,e)){for(var n=e.children,l=n.length,h=null,a=Number.MAX_VALUE,_=null,r="_last_";l--;)if((h=n[l]).direction==s&&h.id!=t.id){var d=h.get_location().y-o;d>0&&d<a&&(a=d,_=h,r="_first_")}_&&(r=_.id),this.jm.move_node(t.id,r,e.id,s)}this.active_node=null,this.target_node=null,this.target_direct=null}jm_event_handle(t,e){t===i.default.event_type.resize&&this.resize()}}var h=new i.default.plugin("draggable_node",(function(t,e){var i=new l(t,e);i.init(),t.add_event_listener((function(t,e){i.jm_event_handle.call(i,t,e)}))}));i.default.register_plugin(h)}));
//# sourceMappingURL=jsmind.draggable-node.js.map
